<?php// Module headerinclude_once 'header.php';// Page template$xoopsOption['template_main'] = 'audio_submit.html';// Xoops Headerinclude_once XOOPS_ROOT_PATH.'/header.php';// Main page style$xoTheme->addStylesheet ( XOOPS_URL . '/modules/audio/css/style.css', null );// Get op$op = audio_CleanVars($_REQUEST, 'op', 'list', 'string');// Check permissionsif ($perm_submit == false) {	redirect_header('index.php', 2, _NOPERM);	exit();}// Do submitswitch ($op){	// Vue liste	case "list":	   $id = audio_CleanVars($_REQUEST, 'id', '', 'string');	   if (@$id) {			echo json_encode(uploadprogress_get_info($id));			exit();		}		      // Get cid		$cid = audio_CleanVars($_GET, 'cid', '0', 'int');		$uuid = uniqid();		   // Add jquery and style		$xoTheme->addScript ( "browse.php?Frameworks/jquery/jquery.js" );		$xoTheme->addScript ( XOOPS_URL . "/modules/audio/js/jquery.progressbar.js" );		$xoTheme->addScript ( XOOPS_URL . "/modules/audio/js/jquery.chili.js" );		$xoTheme->addStylesheet ( XOOPS_URL . '/modules/audio/css/progress.css', null );				//breadcrumb      $xoopsTpl->assign('breadcrumb', '<a href="' . XOOPS_URL . '">' . _MD_AUDIO_HOME . '</a>  &raquo; <a href="index.php">' . $xoopsModule->name() . '</a> &raquo; ' . _MD_AUDIO_SUBMIT_PROPOSER );		// titre de la page		$titre = _MD_AUDIO_SUBMIT_PROPOSER . '&nbsp;-&nbsp;';		$titre .= $xoopsModule->name();		$xoopsTpl->assign('xoops_pagetitle', $titre);				//description		$xoTheme->addMeta( 'meta', 'description', strip_tags(_MD_AUDIO_SUBMIT_PROPOSER));				$obj = $downloads_Handler->create();		$form = $obj->FormOne($uuid, $cid);		$xoopsTpl->assign('themeForm', $form->render());		$xoopsTpl->assign('uuid', $uuid);		$xoopsTpl->assign('token', $GLOBALS['xoopsSecurity']->createToken());		$xoopsTpl->assign('maxuploadsize', $xoopsModuleConfig['maxuploadsize']);				break;			case 'upload':				if (!$GLOBALS['xoopsSecurity']->check()) {			redirect_header('index.php', 3, implode(',', $GLOBALS['xoopsSecurity']->getErrors()));		}				xoops_load("captcha");		$xoopsCaptcha = XoopsCaptcha::getInstance();		if ( !$xoopsCaptcha->verify() ) {			$message_erreur .=$xoopsCaptcha->getMessage().'<br>';			$erreur=true;		}				include_once XOOPS_ROOT_PATH . "/class/uploader.php";		$uploader = new XoopsMediaUploader($uploaddir_downloads, explode('|',$xoopsModuleConfig['mimetype']), $xoopsModuleConfig['maxuploadsize'], null, null);      if ($uploader->fetchMedia($_POST['xoops_upload_file'][0],0)) {      	if ($xoopsModuleConfig['newnamedownload']){      	$uploader->setPrefix ($xoopsModuleConfig['prefixdownloads']);      	}			$uploader->fetchMedia($_POST['xoops_upload_file'][0],0);			if (!$uploader->upload()) {				$errors = $uploader->getErrors();				redirect_header("javascript:history.go(-1)",3, $errors);			   exit ();			} else {				$fileName = $uploader->getSavedFileName();			}			} else {			$errors = $uploader->getErrors ();			redirect_header( "javascript:history.go(-1)", 3, $errors . '<br />' .  _MD_AUDIO_SUBMIT_SIZE);		   exit ();		}      		$obj =& $downloads_Handler->create();		$obj->setVar('filename', $fileName);			$obj->setVar('url', XOOPS_URL);		$obj->setVar('date', time());		$obj->setVar('submitter', !empty($xoopsUser) ? $xoopsUser->getVar('uid') : 0);		$obj->setVar('date', time());				// Get cid		$cid = audio_CleanVars($_GET, 'cid', '0', 'int');		if($cid) {			$obj->setVar('cid', $cid);		}					if ($downloads_Handler->insert($obj)) {			redirect_header( "submit.php?op=convert&id=" . $obj->getVar ( 'lid' ) . "&token=" . $GLOBALS['xoopsSecurity']->createToken() , 0, _MD_AUDIO_SUBMIT_CONVERT);		} else {			redirect_header( "javascript:history.go(-1)", 3, _MD_AUDIO_SUBMIT_ERROR);		   exit ();		}	      break;			case 'convert':				if ($GLOBALS['xoopsSecurity']->check()) {			redirect_header('index.php', 3, implode(',', $GLOBALS['xoopsSecurity']->getErrors()));		}		      $lid = audio_CleanVars( $_REQUEST, 'id', 0, 'int' );		if($lid > 0) {			$obj = $downloads_Handler->get ( $lid );			$objMP3 = new mp3 ($xoopsModuleConfig['ffmpeg'], $uploaddir_downloads, $uploaddir_mp3, $xoopsModuleConfig['asamplerate'], $xoopsModuleConfig['abitrate'], $xoopsModuleConfig['acodec']);
			$objMP3->convert ( $obj->getVar('filename'), $obj->getVar('filename').".mp3");
         $duration = $objMP3->duration($obj->getVar('filename'));
         $obj->setVar('duration', $duration);         $downloads_Handler->insert($obj);             		   redirect_header( "submit.php?op=get&id=" . $obj->getVar ( 'lid' ) . "&token=" . $GLOBALS['xoopsSecurity']->createToken(), 3, _MD_AUDIO_SUBMIT_INPUT);		} else {			redirect_header( "index.php", 3, _NOPERM);			exit ();		}	      break;         case 'get':				if ($GLOBALS['xoopsSecurity']->check()) {			redirect_header('index.php', 3, implode(',', $GLOBALS['xoopsSecurity']->getErrors()));		}			   $lid = audio_CleanVars($_REQUEST, 'id', 0, 'int');		if($lid > 0) {			$obj = $downloads_Handler->get($lid);			$form = $obj->FormTwo();			$xoopsTpl->assign('themeForm', $form->render());		} else {			redirect_header( "index.php", 3, _NOPERM);			exit ();		}			break;			case 'save':				if (!$GLOBALS['xoopsSecurity']->check()) {			redirect_header('index.php', 3, implode(',', $GLOBALS['xoopsSecurity']->getErrors()));		}				$lid = audio_CleanVars($_GET, 'id', 0, 'int');		if($lid > 0) {			$obj =& $downloads_Handler->get($lid);			$obj->setVar('title', filter_var( $_POST['title'], FILTER_SANITIZE_MAGIC_QUOTES ));			$obj->setVar('cid', filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT ));		   $obj->setVar('top', filter_var( $_POST['top'], FILTER_SANITIZE_NUMBER_INT ));		   $obj->setVar('homepage', filter_var($_POST['homepage'], FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED));			$obj->setVar('version', filter_var( $_POST['version'], FILTER_SANITIZE_NUMBER_INT ));						if (isset($_POST['platform'])) {				$obj->setVar('platform', implode('|',$_POST['platform']));			}			$obj->setVar('description', $_POST['description']);			if ($xoopsUser) {				if ( $xoopsUser->isAdmin($xoopsModule->mid()) ) {					if (isset($_POST['status'])){						$obj->setVar('status', intval($_POST['status']));
						Audio_Updateposts($obj->getVar('submitter'), intval($_POST['status']), 'add');					}else{						$obj->setVar('status', 0);					}				}			}
         // Pour l'image
	      include_once XOOPS_ROOT_PATH . "/class/uploader.php";			$uploader = new XoopsMediaUploader($uploaddir_shots, array('image/gif', 'image/jpeg', 'image/pjpeg', 'image/x-png', 'image/png'), $xoopsModuleConfig['maxuploadsize'], null, null);	      if ($uploader->fetchMedia($_POST['xoops_upload_file'][0],0)) {		      $uploader->setPrefix('audio_image_');				$uploader->fetchMedia($_POST['xoops_upload_file'][0],0);				if (!$uploader->upload()) {					$errors = $uploader->getErrors();					redirect_header("javascript:history.go(-1)",3, $errors);				   exit ();				} else {					$obj->setVar('logourl', $uploader->getSavedFileName());				}				} else {				$errors = $uploader->getErrors ();				redirect_header( "javascript:history.go(-1)", 3, $errors . '<br />' .  _MD_AUDIO_SUBMIT_SIZE);			   exit ();			}
			if ($downloads_Handler->insert($obj)) {				//tags				if (($xoopsModuleConfig['usetag'] == 1) and (is_dir('../tag'))){					$tag_handler = xoops_getmodulehandler('tag', 'tag');					$tag_handler->updateByItem($_POST['tag'], $lid, $xoopsModule->getVar('dirname'), 0);				}				// R�cup�ration des champs suppl�mentaires:				$criteria = new CriteriaCompo();				$criteria->setSort('weight ASC, title');				$criteria->setOrder('ASC');				$downloads_field = $downloadsfield_Handler->getall($criteria);				foreach (array_keys($downloads_field) as $i) {					if ($downloads_field[$i]->getVar('status_def') == 0){						$objdata =& $downloadsfielddata_Handler->create();						$nom_champ = 'champ' . $downloads_field[$i]->getVar('fid');						$objdata->setVar('data', $_POST[$nom_champ]);						$objdata->setVar('lid', $lid);						$objdata->setVar('fid', $downloads_field[$i]->getVar('fid'));						$downloadsfielddata_Handler->insert($objdata) or $objdata->getHtmlErrors();					}				}								$notification_handler =& xoops_gethandler('notification');				$tags = array();				$tags['FILE_NAME'] = filter_var( $_POST['title'], FILTER_SANITIZE_MAGIC_QUOTES );				$tags['FILE_URL'] = XOOPS_URL . '/modules/' . $xoopsModule->getVar('dirname') . '/singlefile.php?cid=' . filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT ) . '&lid=' . $lid;				$downloadscat_cat = $downloadscat_Handler->get(filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT ));				$tags['CATEGORY_NAME'] = $downloadscat_cat->getVar('title');				$tags['CATEGORY_URL'] = XOOPS_URL . '/modules/' . $xoopsModule->getVar('dirname') . '/viewcat.php?cid=' . filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT );				if ($perm_autoapprove == true) {					$notification_handler->triggerEvent('global', 0, 'new_file', $tags);					$notification_handler->triggerEvent('category', filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT ), 'new_file', $tags);					redirect_header('index.php',2,_MD_AUDIO_SUBMIT_RECEIVED . '<br />' . _MD_AUDIO_SUBMIT_ISAPPROVED . '');					exit;				} else {					$tags['WAITINGFILES_URL'] = XOOPS_URL . '/modules/audio/admin/index.php?op=listNewDownloads';					$notification_handler->triggerEvent('global', 0, 'file_submit', $tags);					$notification_handler->triggerEvent('category', filter_var( $_POST['cid'], FILTER_SANITIZE_NUMBER_INT ), 'file_submit', $tags);					redirect_header('index.php',2,_MD_AUDIO_SUBMIT_RECEIVED);					exit;				}							} else {				redirect_header( "index.php", 3, _MD_AUDIO_SUBMIT_ERROR);			   exit ();			}				} else {			redirect_header( "index.php", 3, _NOPERM);		   exit ();		}			break;	}include XOOPS_ROOT_PATH.'/footer.php';?>